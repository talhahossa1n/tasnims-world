<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Tasnim's World</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
  </head>
  <body style="background-color: #f8f9fa">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
      <a class="navbar-brand" href="index.html">Tasnim's World</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="products.html">Products</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link cart-icon" href="products.html#cartSidebar"
              ><i class="fas fa-shopping-cart"></i>
              <span class="cart-badge"></span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="contact.html">Contact</a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Checkout Section -->
    <div class="container mt-5">
      <div class="row">
        <div class="col-md-8">
          <h2 class="mb-4">Billing Details</h2>
          <form id="checkoutForm" method="POST" action="/checkout">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="firstName">First Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="firstName"
                  name="firstName"
                  placeholder="First Name"
                  required
                />
              </div>
              <div class="form-group col-md-6">
                <label for="lastName">Last Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="lastName"
                  name="lastName"
                  placeholder="Last Name"
                  required
                />
              </div>
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input
                type="email"
                class="form-control"
                id="email"
                name="email"
                placeholder="Email"
                required
              />
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <input
                type="text"
                class="form-control"
                id="address"
                name="address"
                placeholder="1234 Main St"
                required
              />
            </div>
            <div class="form-group">
              <label for="address2">Address 2</label>
              <input
                type="text"
                class="form-control"
                id="address2"
                name="address2"
                placeholder="Apartment, studio, or floor"
              />
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="city">City</label>
                <input
                  type="text"
                  class="form-control"
                  id="city"
                  name="city"
                  required
                />
              </div>
              <div class="form-group col-md-4">
                <label for="district">District</label>
                <select id="district" name="district" class="form-control">
                  <option selected>Dhaka</option>
                  <option>Chittagong</option>
                  <option>Khulna</option>
                  <option>Rajshahi</option>
                  <option>Barishal</option>
                  <option>Sylhet</option>
                  <option>Rangpur</option>
                  <option>Mymensingh</option>
                </select>
              </div>
              <div class="form-group col-md-2">
                <label for="zip">Zip</label>
                <input
                  type="number"
                  class="form-control"
                  id="zip"
                  name="zip"
                  oninput="this.value = this.value.slice(0, 4)"
                  required
                />
              </div>
            </div>
            <div class="form-group">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="gridCheck"
                  name="gridCheck"
                  required
                />
                <label class="form-check-label" for="gridCheck">
                  Agree to terms and conditions
                </label>
              </div>
            </div>
            <button type="submit" class="btn btn-danger">Place Order</button>
          </form>
        </div>
        <div class="col-md-4">
          <h2 class="mb-4">Your Order</h2>
          <ul class="list-group mb-3" id="orderSummary">
            <!-- Cart items will be dynamically inserted here -->
          </ul>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-white bg-danger mt-5 p-3">
      <p>&copy; 2023 Tasnim's World. All rights reserved.</p>
    </footer>

    <!-- Success Modal -->
    <div
      class="modal fade"
      id="successModal"
      tabindex="-1"
      aria-labelledby="successModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="successModalLabel">
              Order Confirmation
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-center">
            <i
              class="fas fa-check-circle"
              style="color: green; font-size: 3rem"
            ></i>
          </div>
          <div class="modal-body text-center">
            Your order has been placed successfully!
          </div>
          <div class="modal-footer justify-content-center">
            <!-- <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button> -->
            <button type="button" class="btn btn-danger" id="goHomeBtn">
              Go to Home
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="script.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const orderSummary = document.getElementById("orderSummary");
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const successModal = new bootstrap.Modal(
          document.getElementById("successModal")
        );
        const goHomeBtn = document.getElementById("goHomeBtn");

        function updateOrderSummary() {
          orderSummary.innerHTML = ""; // Clear current order summary

          if (cart.length === 0) {
            orderSummary.innerHTML = "<p>No items in the cart yet!</p>";
            return;
          }

          let total = 0;
          cart.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;

            const orderItem = document.createElement("li");
            orderItem.className =
              "list-group-item d-flex justify-content-between lh-condensed";
            orderItem.innerHTML = `
              <div>
                <h6 class="my-0">${item.name}</h6>
                <small class="text-muted">${
                  item.quantity
                } x $${item.price.toFixed(2)}</small>
              </div>
              <span class="text-muted">$${itemTotal.toFixed(2)}</span>
              <div>
                <button class="btn btn-sm btn-success increase-btn" data-index="${index}">+</button>
                <button class="btn btn-sm btn-danger decrease-btn" data-index="${index}">-</button>
                <button class="btn btn-sm btn-dark remove-btn" data-index="${index}">Remove</button>
              </div>
            `;

            orderSummary.appendChild(orderItem);
          });

          const totalElement = document.createElement("li");
          totalElement.className =
            "list-group-item d-flex justify-content-between";
          totalElement.innerHTML = `
            <span>Total (USD)</span>
            <strong>$${total.toFixed(2)}</strong>
          `;
          orderSummary.appendChild(totalElement);
        }

        updateOrderSummary();

        // Handle form submission
        document
          .getElementById("checkoutForm")
          .addEventListener("submit", (event) => {
            event.preventDefault();

            const formData = new FormData(event.target);
            const formObject = Object.fromEntries(formData.entries());
            formObject.cart = cart;

            fetch("/checkout", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formObject),
            })
              .then((response) => response.json())
              .then((data) => {
                // Show success modal
                successModal.show();
                localStorage.removeItem("cart"); // Clear cart after successful order
              })
              .catch((error) => {
                console.error("Error:", error);
              });
          });

        // Handle "Go to Home" button click in the modal
        if (goHomeBtn) {
          goHomeBtn.addEventListener("click", () => {
            window.location.href = "/";
          });
        }

        // Handle cart item actions (increase, decrease, remove)
        orderSummary.addEventListener("click", (event) => {
          const index = event.target.dataset.index;

          if (event.target.classList.contains("increase-btn")) {
            cart[index].quantity += 1;
          } else if (event.target.classList.contains("decrease-btn")) {
            if (cart[index].quantity > 1) {
              cart[index].quantity -= 1;
            } else {
              cart.splice(index, 1); // Remove item if quantity reaches 0
            }
          } else if (event.target.classList.contains("remove-btn")) {
            cart.splice(index, 1); // Remove item from cart
          }

          localStorage.setItem("cart", JSON.stringify(cart)); // Save updated cart to localStorage
          updateOrderSummary();
        });
      });
    </script>
  </body>
</html>
